From 65a3467c2c24b33e2f54d54562e1e2262524516d Mon Sep 17 00:00:00 2001
From: Martin Panzer <postremus1996@googlemail.com>
Date: Mon, 9 Oct 2017 18:56:29 -0400
Subject: [PATCH] Fix FallingBlocks being stuck on fences

Fallingblocks would previously only check if directly beneath them a block exists. They also
hover on top of the 1.5 block tall hitbox of fences during these check. This
resulted in them always thinking they would be on air.

We now first check, if if we are already on the ground.
if not, we check if the falling block is inside of the hitbox of the block at y - 1.

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index e34d5fd..4cf01a9 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -330,4 +330,9 @@ public class PaperWorldConfig {
         preventTntFromMovingInWater = getBoolean("prevent-tnt-from-moving-in-water", false);
         log("Prevent TNT from moving in water: " + preventTntFromMovingInWater);
     }
+
+    public boolean altFallingBlockOnGround;
+    private void altFallingBlockOnGround() {
+        altFallingBlockOnGround = getBoolean("use-alternate-fallingblock-onGround-detection", false);
+    }
 }
diff --git a/src/main/java/net/minecraft/entity/item/EntityFallingBlock.java b/src/main/java/net/minecraft/entity/item/EntityFallingBlock.java
index 9743533..eddb849 100644
--- a/src/main/java/net/minecraft/entity/item/EntityFallingBlock.java
+++ b/src/main/java/net/minecraft/entity/item/EntityFallingBlock.java
@@ -2,6 +2,7 @@ package net.minecraft.entity.item;
 
 import com.google.common.collect.Lists;
 import java.util.ArrayList;
+import java.util.List;
 import javax.annotation.Nullable;
 import net.minecraft.block.Block;
 import net.minecraft.block.BlockAnvil;
@@ -24,10 +25,7 @@ import net.minecraft.util.DamageSource;
 import net.minecraft.util.EnumFacing;
 import net.minecraft.util.ResourceLocation;
 import net.minecraft.util.datafix.DataFixer;
-import net.minecraft.util.math.BlockPos;
-import net.minecraft.util.math.MathHelper;
-import net.minecraft.util.math.RayTraceResult;
-import net.minecraft.util.math.Vec3d;
+import net.minecraft.util.math.*;
 import net.minecraft.world.World;
 import org.bukkit.craftbukkit.event.CraftEventFactory;
 
@@ -152,10 +150,9 @@ public class EntityFallingBlock extends Entity {
                 } else {
                     IBlockState iblockdata = this.world.getBlockState(blockposition);
 
-                    if (!flag1
-                            && BlockFalling.canFallThrough(
-                                    this.world.getBlockState(new BlockPos(this.posX, this.posY - 0.009999999776482582D, this.posZ)))) {
+                    if (!isOnGround()) {
                         this.onGround = false;
+                        if (this.world.paperConfig.altFallingBlockOnGround) return; // Paper
                     }
 
                     this.motionX *= 0.699999988079071D;
@@ -334,4 +331,25 @@ public class EntityFallingBlock extends Entity {
     public boolean ignoreItemEntityData() {
         return true;
     }
+
+    // Paper start
+    private boolean isOnGround() {
+        BlockPos where = new BlockPos(this.posX, this.posY - 0.009999999776482582D, this.posZ);
+        boolean cannotMoveThrough = !BlockFalling.canFallThrough(this.world.getBlockState(where));
+        if (!this.world.paperConfig.altFallingBlockOnGround) return cannotMoveThrough;
+
+        if (cannotMoveThrough) {
+            return true;
+        }
+
+        IBlockState blockData = this.world.getBlockState(where.down());
+        if (BlockFalling.canFallThrough(blockData)) {
+            return false;
+        }
+
+        List<AxisAlignedBB> list = new ArrayList<>();
+        blockData.addCollisionBoxToList(world, where, this.getEntityBoundingBox(), list, this, false);
+        return list.size() > 0;
+    }
+    // Paper end
 }
-- 
2.18.0

