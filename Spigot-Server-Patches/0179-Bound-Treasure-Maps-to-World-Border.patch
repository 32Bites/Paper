From a2f165af7f1b7341eedb75cba4b54f7866feddee Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Fri, 20 Oct 2017 19:54:33 -0400
Subject: [PATCH] Bound Treasure Maps to World Border

Make it so a Treasure Map does not target a structure outside of the
World Border, where players are not even able to reach.

This also would help the case where a players close to the border, and one
that is outside happens to be closer, but unreachable, yet another reachable
one is in border that would of been missed.

diff --git a/src/main/java/net/minecraft/world/border/WorldBorder.java b/src/main/java/net/minecraft/world/border/WorldBorder.java
index 97e570a..e6ebbfb 100644
--- a/src/main/java/net/minecraft/world/border/WorldBorder.java
+++ b/src/main/java/net/minecraft/world/border/WorldBorder.java
@@ -32,6 +32,18 @@ public class WorldBorder {
         this.warningDistance = 5;
     }
 
+    // Paper start
+    private final BlockPos.MutableBlockPos mutPos = new BlockPos.MutableBlockPos();
+    public boolean containsBlock(int chunkX, int chunkZ) {
+        mutPos.setPos(chunkX, 64, chunkZ);
+        return contains(mutPos);
+    }
+    public boolean containsChunk(int chunkX, int chunkZ) {
+        mutPos.setPos(((chunkX << 4) + 15), 64, (chunkZ << 4) + 15);
+        return contains(mutPos);
+    }
+    // Paper end
+
     public boolean contains(BlockPos pos) {
         return (double) (pos.getX() + 1) > this.minX()
                 && (double) pos.getX() < this.maxX()
diff --git a/src/main/java/net/minecraft/world/gen/structure/MapGenStructure.java b/src/main/java/net/minecraft/world/gen/structure/MapGenStructure.java
index 7afa3ac..294cb95 100644
--- a/src/main/java/net/minecraft/world/gen/structure/MapGenStructure.java
+++ b/src/main/java/net/minecraft/world/gen/structure/MapGenStructure.java
@@ -262,6 +262,8 @@ public abstract class MapGenStructure extends MapGenBase {
                         MapGenBase.setupChunkSeed(worldIn.getSeed(), random, l2, i3);
                         random.nextInt();
 
+                        if (!worldIn.getWorldBorder().containsChunk(l2, i3)) { continue; } // Paper
+
                         if (p_191069_1_.canSpawnStructureAtCoords(l2, i3)) {
                             if (!findUnexplored || !worldIn.isChunkGeneratedAt(l2, i3)) {
                                 return new BlockPos((l2 << 4) + 8, 64, (i3 << 4) + 8);
-- 
2.18.0

