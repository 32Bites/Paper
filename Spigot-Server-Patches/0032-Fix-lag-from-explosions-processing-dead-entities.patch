From 4bb001a1a6d68e5c0c41eb154da0697732cd589a Mon Sep 17 00:00:00 2001
From: Iceee <andrew@opticgaming.tv>
Date: Sun, 24 Sep 2017 16:45:55 -0400
Subject: [PATCH] Fix lag from explosions processing dead entities


diff --git a/src/main/java/net/minecraft/world/Explosion.java b/src/main/java/net/minecraft/world/Explosion.java
index 1a1b473..19dfc82 100644
--- a/src/main/java/net/minecraft/world/Explosion.java
+++ b/src/main/java/net/minecraft/world/Explosion.java
@@ -1,5 +1,6 @@
 package net.minecraft.world;
 
+import com.google.common.base.Predicate;
 import com.google.common.collect.Lists;
 import com.google.common.collect.Maps;
 import com.google.common.collect.Sets;
@@ -20,6 +21,7 @@ import net.minecraft.entity.projectile.EntityFireball;
 import net.minecraft.init.Blocks;
 import net.minecraft.init.SoundEvents;
 import net.minecraft.util.DamageSource;
+import net.minecraft.util.EntitySelectors;
 import net.minecraft.util.EnumParticleTypes;
 import net.minecraft.util.SoundCategory;
 import net.minecraft.util.math.AxisAlignedBB;
@@ -115,9 +117,9 @@ public class Explosion {
             int i1 = MathHelper.floor(this.y + (double) f3 + 1.0D);
             int j1 = MathHelper.floor(this.z - (double) f3 - 1.0D);
             int k1 = MathHelper.floor(this.z + (double) f3 + 1.0D);
-            List list =
-                    this.world.getEntitiesWithinAABBExcludingEntity(
-                            this.exploder, new AxisAlignedBB((double) i, (double) l, (double) j1, (double) j, (double) i1, (double) k1));
+            // Paper - No reason to include dead entities or entities we can't damage
+            List list = this.world.getEntitiesInAABBexcluding(this.exploder, new AxisAlignedBB((double) i, (double) l,(double) j1, (double) j, (double) i1, (double) k1),
+                    input -> input != null && !input.isDead && EntitySelectors.CAN_AI_TARGET.apply(input));
             Vec3d vec3d = new Vec3d(this.x, this.y, this.z);
 
             for (int l1 = 0; l1 < list.size(); ++l1) {
-- 
2.18.0

