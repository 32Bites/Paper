From d2f1a3026370a6c51bb53e47e814ed1bcc2f10f5 Mon Sep 17 00:00:00 2001
From: Zach Brown <zach.brown@destroystokyo.com>
Date: Sun, 1 Oct 2017 00:24:39 -0400
Subject: [PATCH] Support offline mode in whitelist command as well


diff --git a/src/main/java/net/minecraft/command/server/CommandWhitelist.java b/src/main/java/net/minecraft/command/server/CommandWhitelist.java
index d82c1ff..1c0ef46 100644
--- a/src/main/java/net/minecraft/command/server/CommandWhitelist.java
+++ b/src/main/java/net/minecraft/command/server/CommandWhitelist.java
@@ -50,6 +50,8 @@ public class CommandWhitelist extends CommandBase {
                     throw new WrongUsageException("commands.whitelist.add.usage", new Object[0]);
                 }
 
+                // Paper start - Handle offline mode as well
+                /*
                 GameProfile var5 = server.getPlayerProfileCache().getGameProfileForUsername(args[1]);
 
                 if (var5 == null) {
@@ -57,12 +59,17 @@ public class CommandWhitelist extends CommandBase {
                 }
 
                 server.getPlayerList().addWhitelistedPlayer(var5);
+                */
+                this.whitelist(server, args[1], true);
+                // Paper end
                 notifyCommandListener(mcpSender, this, "commands.whitelist.add.success", new Object[] {args[1]});
             } else if ("remove".equals(args[0])) {
                 if (args.length < 2) {
                     throw new WrongUsageException("commands.whitelist.remove.usage", new Object[0]);
                 }
 
+                // Paper start - Handle offline mode as well
+                /*
                 GameProfile var6 = server.getPlayerList().getWhitelistedPlayers().getByName(args[1]);
 
                 if (var6 == null) {
@@ -70,6 +77,9 @@ public class CommandWhitelist extends CommandBase {
                 }
 
                 server.getPlayerList().removePlayerFromWhitelist(var6);
+                */
+                this.whitelist(server, args[1], false);
+                // Paper end
                 notifyCommandListener(mcpSender, this, "commands.whitelist.remove.success", new Object[] {args[1]});
             } else if ("reload".equals(args[0])) {
                 server.getPlayerList().reloadWhitelist();
@@ -95,4 +105,43 @@ public class CommandWhitelist extends CommandBase {
             return Collections.<String>emptyList();
         }
     }
+    // Paper start
+    /**
+          * Adds or removes a player from the game whitelist
+          *
+          * @param server running instance of MinecraftServer
+          * @param playerName the player we're going to be whitelisting
+          * @param add whether we're adding or removing from the whitelist
+          */
+    private void whitelist(MinecraftServer server, String playerName, boolean add) throws CommandException {
+        if (server.isServerInOnlineMode()) {
+            // The reason we essentially copy/pasta NMS code here is because the NMS online-only version
+            // is capable of providing feedback to the person running the command based on whether or
+            // not the player is a real online-mode account
+            GameProfile profile = server.getPlayerProfileCache().getGameProfileForUsername(playerName);
+
+            if (profile == null) {
+                if (add) {
+                    throw new CommandException("commands.whitelist.add.failed", playerName);
+                } else {
+                    throw new CommandException("commands.whitelist.remove.failed", playerName);
+                }
+            }
+
+            if (add) {
+                server.getPlayerList().addWhitelistedPlayer(profile);
+            } else {
+                server.getPlayerList().removePlayerFromWhitelist(profile);
+            }
+        } else {
+            // versus our offline version, which will always report success all of the time
+            org.bukkit.OfflinePlayer offlinePlayer = org.bukkit.Bukkit.getOfflinePlayer(playerName);
+            if (add) {
+                offlinePlayer.setWhitelisted(true);
+            } else {
+                offlinePlayer.setWhitelisted(false);
+            }
+        }
+    }
+    // Paper end
 }
-- 
2.18.0

