From 5307ee46a4345bdcc94a9d5b0154d54d58dbdf2b Mon Sep 17 00:00:00 2001
From: Jedediah Smith <jedediah@silencegreys.com>
Date: Tue, 1 Mar 2016 14:47:52 -0600
Subject: [PATCH] Affects spawning API


diff --git a/src/main/java/net/minecraft/entity/EntityLiving.java b/src/main/java/net/minecraft/entity/EntityLiving.java
index b0dd705..6f23756 100644
--- a/src/main/java/net/minecraft/entity/EntityLiving.java
+++ b/src/main/java/net/minecraft/entity/EntityLiving.java
@@ -648,7 +648,7 @@ public abstract class EntityLiving extends EntityLivingBase {
         } else {
             EntityPlayer entityhuman = this.world.getClosestPlayerToEntity(this, -1.0D);
 
-            if (entityhuman != null) {
+            if (entityhuman != null && entityhuman.affectsSpawning) { // Paper - Affects Spawning API
                 double d0 = entityhuman.posX - this.posX;
                 double d1 = entityhuman.posY - this.posY;
                 double d2 = entityhuman.posZ - this.posZ;
diff --git a/src/main/java/net/minecraft/entity/monster/EntitySilverfish.java b/src/main/java/net/minecraft/entity/monster/EntitySilverfish.java
index 7fe0c70..0fdcc81 100644
--- a/src/main/java/net/minecraft/entity/monster/EntitySilverfish.java
+++ b/src/main/java/net/minecraft/entity/monster/EntitySilverfish.java
@@ -123,7 +123,7 @@ public class EntitySilverfish extends EntityMob {
     public boolean getCanSpawnHere() {
         if (super.getCanSpawnHere()) {
             EntityPlayer entityhuman = this.world.getNearestPlayerNotCreative(this, 5.0D);
-            return entityhuman == null;
+            return !(entityhuman != null && !entityhuman.affectsSpawning) && entityhuman == null; // Paper - Affects Spawning API
         } else {
             return false;
         }
diff --git a/src/main/java/net/minecraft/entity/player/EntityPlayer.java b/src/main/java/net/minecraft/entity/player/EntityPlayer.java
index ef2bca2..74dbedf 100644
--- a/src/main/java/net/minecraft/entity/player/EntityPlayer.java
+++ b/src/main/java/net/minecraft/entity/player/EntityPlayer.java
@@ -151,6 +151,7 @@ public abstract class EntityPlayer extends EntityLivingBase {
     public boolean fauxSleeping;
     public String spawnWorld = "";
     public int oldLevel = -1;
+    public boolean affectsSpawning = true;
 
     public CraftHumanEntity getBukkitEntity() {
         return (CraftHumanEntity) super.getBukkitEntity();
diff --git a/src/main/java/net/minecraft/world/World.java b/src/main/java/net/minecraft/world/World.java
index 39094b6..857a43c 100644
--- a/src/main/java/net/minecraft/world/World.java
+++ b/src/main/java/net/minecraft/world/World.java
@@ -2758,7 +2758,7 @@ public abstract class World implements IBlockAccess {
         for (int i = 0; i < this.playerEntities.size(); ++i) {
             EntityPlayer entityhuman = this.playerEntities.get(i);
 
-            if (EntitySelectors.NOT_SPECTATING.apply(entityhuman)) {
+            if (EntitySelectors.NOT_SPECTATING.apply(entityhuman)&& entityhuman.affectsSpawning) { // Paper - Affects Spawning API
                 double d4 = entityhuman.getDistanceSq(x, y, z);
 
                 if (range < 0.0D || d4 < range * range) {
diff --git a/src/main/java/net/minecraft/world/WorldEntitySpawner.java b/src/main/java/net/minecraft/world/WorldEntitySpawner.java
index f60d787..522244e 100644
--- a/src/main/java/net/minecraft/world/WorldEntitySpawner.java
+++ b/src/main/java/net/minecraft/world/WorldEntitySpawner.java
@@ -56,7 +56,7 @@ public final class WorldEntitySpawner {
             int i = 0;
 
             for (EntityPlayer entityhuman : worldServerIn.playerEntities) {
-                if (!entityhuman.isSpectator()) {
+                if (!entityhuman.isSpectator() && entityhuman.affectsSpawning) { // Paper - Affects spawning API
                     int l = MathHelper.floor(entityhuman.posX / 16.0D);
                     int j = MathHelper.floor(entityhuman.posZ / 16.0D);
                     boolean flag3 = true;
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 1df7db7..fc45a6b 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1599,6 +1599,18 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         return this.getHandle().language;
     }
 
+    // Paper start
+    @Override
+    public void setAffectsSpawning(boolean affects) {
+        this.getHandle().affectsSpawning = affects;
+    }
+
+    @Override
+    public boolean getAffectsSpawning() {
+        return this.getHandle().affectsSpawning;
+    }
+    // Paper end
+
     public Player.Spigot spigot() { // Paper - Decompile fix
         return this.spigot;
     }
-- 
2.18.0

