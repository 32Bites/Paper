From 505eab5c1353481369e391d671d9ddd562bb38eb Mon Sep 17 00:00:00 2001
From: Jedediah Smith <jedediah@silencegreys.com>
Date: Wed, 27 Sep 2017 14:22:10 -0400
Subject: [PATCH] Send absolute position the first time an entity is seen


diff --git a/src/main/java/net/minecraft/entity/EntityTrackerEntry.java b/src/main/java/net/minecraft/entity/EntityTrackerEntry.java
index 9ef18e1..7548865 100644
--- a/src/main/java/net/minecraft/entity/EntityTrackerEntry.java
+++ b/src/main/java/net/minecraft/entity/EntityTrackerEntry.java
@@ -97,7 +97,12 @@ public class EntityTrackerEntry {
     private boolean ridingEntity;
     private boolean onGround;
     public boolean playerEntitiesUpdated;
-    public final Set<EntityPlayerMP> trackingPlayers = Sets.<EntityPlayerMP>newHashSet();
+    // Paper start
+    // Replace trackingPlayers Set with a Map. The value is true until the player receives
+    // their first update (which is forced to have absolute coordinates), false afterward.
+    public java.util.Map<EntityPlayerMP, Boolean> trackedPlayerMap = new java.util.HashMap<>();
+    public Set<EntityPlayerMP> trackingPlayers = trackedPlayerMap.keySet();
+    // Paper end
 
     public EntityTrackerEntry(Entity entityIn, int rangeIn, int maxRangeIn, int updateFrequencyIn, boolean sendVelocityUpdatesIn) {
         this.trackedEntity = entityIn;
@@ -201,6 +206,8 @@ public class EntityTrackerEntry {
                 boolean flag1 = l1 * l1 + i2 * i2 + j2 * j2 >= 128L || this.updateCounter % 60 == 0;
                 boolean flag2 = Math.abs(j1 - this.encodedRotationYaw) >= 1 || Math.abs(k1 - this.encodedRotationPitch) >= 1;
 
+                if (this.updateCounter > 0 || this.trackedEntity instanceof EntityArrow) { // Paper - Moved up
+
                 if (flag1) {
                     this.encodedPosX = k;
                     this.encodedPosY = l;
@@ -212,7 +219,6 @@ public class EntityTrackerEntry {
                     this.encodedRotationPitch = k1;
                 }
 
-                if (this.updateCounter > 0 || this.trackedEntity instanceof EntityArrow) {
                     if (l1 >= -32768L
                             && l1 < 32768L
                             && i2 >= -32768L
@@ -287,7 +293,26 @@ public class EntityTrackerEntry {
                 }
 
                 if (object != null) {
-                    this.sendPacketToTrackedPlayers((Packet) object);
+                    // Paper start - ensure fresh viewers get an absolute position on their first update,
+                    // since we can't be certain what position they received in the spawn packet.
+                    if (object instanceof SPacketEntityTeleport) {
+                        this.sendPacketToTrackedPlayers((Packet) object);
+                    } else {
+                        SPacketEntityTeleport teleportPacket = null;
+
+                        for (java.util.Map.Entry<EntityPlayerMP, Boolean> viewer : trackedPlayerMap.entrySet()) {
+                            if (viewer.getValue()) {
+                                viewer.setValue(false);
+                                if (teleportPacket == null) {
+                                    teleportPacket = new SPacketEntityTeleport(this.trackedEntity);
+                                }
+                                viewer.getKey().connection.sendPacket(teleportPacket);
+                            } else {
+                                viewer.getKey().connection.sendPacket((Packet) object);
+                            }
+                        }
+                    }
+                    // Paper end
                 }
 
                 this.sendMetadata();
@@ -398,7 +423,7 @@ public class EntityTrackerEntry {
                     }
 
                     playerMP.entityRemoveQueue.remove(Integer.valueOf(this.trackedEntity.getEntityId()));
-                    this.trackingPlayers.add(playerMP);
+                    this.trackedPlayerMap.put(playerMP, true); // Paper
                     Packet packet = this.createSpawnPacket();
                     playerMP.connection.sendPacket(packet);
 
-- 
2.18.0

