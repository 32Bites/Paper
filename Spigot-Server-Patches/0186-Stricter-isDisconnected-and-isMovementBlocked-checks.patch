From dc356c23f37a401d716ceef16d601a3f745c6061 Mon Sep 17 00:00:00 2001
From: Alfie Cleveland <alfeh@me.com>
Date: Fri, 20 Oct 2017 20:19:22 -0400
Subject: [PATCH] Stricter isDisconnected and isMovementBlocked checks

Credit to prplz for figuring out specifics

diff --git a/src/main/java/net/minecraft/entity/player/EntityPlayerMP.java b/src/main/java/net/minecraft/entity/player/EntityPlayerMP.java
index f6ca53e..7cfad60 100644
--- a/src/main/java/net/minecraft/entity/player/EntityPlayerMP.java
+++ b/src/main/java/net/minecraft/entity/player/EntityPlayerMP.java
@@ -1550,7 +1550,7 @@ public class EntityPlayerMP extends EntityPlayer implements IContainerListener {
     }
 
     public boolean isMovementBlocked() {
-        return super.isMovementBlocked() || !this.getBukkitEntity().isOnline();
+        return super.isMovementBlocked() || (this.connection != null && this.connection.isDisconnected()); // Paper - Stricter check
     }
 
     public Scoreboard getWorldScoreboard() {
diff --git a/src/main/java/net/minecraft/network/NetHandlerPlayServer.java b/src/main/java/net/minecraft/network/NetHandlerPlayServer.java
index 7622a21..a132a27 100644
--- a/src/main/java/net/minecraft/network/NetHandlerPlayServer.java
+++ b/src/main/java/net/minecraft/network/NetHandlerPlayServer.java
@@ -2887,6 +2887,6 @@ public class NetHandlerPlayServer implements INetHandlerPlayServer, ITickable {
     }
 
     public final boolean isDisconnected() {
-        return !this.player.joining && !this.netManager.isChannelOpen();
+        return (!this.player.joining && !this.netManager.isChannelOpen()) || this.processedDisconnect; // Paper - Stricter check
     }
 }
-- 
2.18.0

