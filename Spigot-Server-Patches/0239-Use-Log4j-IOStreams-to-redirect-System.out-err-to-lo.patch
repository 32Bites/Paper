From b7c7ca7a8155ae251ac7eb7eb536f6d0e7962bed Mon Sep 17 00:00:00 2001
From: Minecrell <dev@minecrell.net>
Date: Tue, 31 Oct 2017 20:16:55 -0400
Subject: [PATCH] Use Log4j IOStreams to redirect System.out/err to logger

Log4j2 provides an optimized implementation of PrintStream that
redirects its output to a logger. Use it instead of a custom
implementation for minor performance improvements and some fixes.

With the old implementation, each call to System.print()
results in a separate line, even though it should not result in
a line break. Log4j's implementation handles it correctly.

diff --git a/build.gradle b/build.gradle
index ae697fe..d834e2c 100644
--- a/build.gradle
+++ b/build.gradle
@@ -30,6 +30,7 @@ dependencies {
     compile "org.xerial:sqlite-jdbc:3.21.0"
     compile "mysql:mysql-connector-java:5.1.43"
     compile "net.minecrell:terminalconsoleappender:1.0.0"
+    compile "org.apache.logging.log4j:log4j-iostreams:2.8.1"
     runtime "net.java.dev.jna:jna:4.4.0"
     /*
       Required to add the missing Log4j2Plugins.dat file from log4j-core
diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index e0e49fc..b2ee113 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -163,8 +163,10 @@ public class DedicatedServer extends MinecraftServer implements IServer {
         */
         // Paper end
 
-        System.setOut(new PrintStream(new LoggerOutputStream(logger, Level.INFO), true));
-        System.setErr(new PrintStream(new LoggerOutputStream(logger, Level.WARN), true));
+        // Paper start - Use Log4j IOStreams
+        System.setOut(org.apache.logging.log4j.io.IoBuilder.forLogger(logger).setLevel(Level.INFO).buildPrintStream());
+        System.setErr(org.apache.logging.log4j.io.IoBuilder.forLogger(logger).setLevel(Level.WARN).buildPrintStream());
+        // Paper end
         thread.setDaemon(true);
         thread.start();
         LOGGER.info("Starting minecraft server version 1.12.2");
-- 
2.18.0

