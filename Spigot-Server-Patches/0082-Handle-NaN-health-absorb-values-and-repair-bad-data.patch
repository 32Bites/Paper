From 3edec0afc2a8c45a27fb96ac7a2f448c87f39c52 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sun, 1 Oct 2017 00:14:27 -0400
Subject: [PATCH] Handle NaN health/absorb values and repair bad data


diff --git a/src/main/java/net/minecraft/entity/EntityLivingBase.java b/src/main/java/net/minecraft/entity/EntityLivingBase.java
index e908050..e77b982 100644
--- a/src/main/java/net/minecraft/entity/EntityLivingBase.java
+++ b/src/main/java/net/minecraft/entity/EntityLivingBase.java
@@ -564,7 +564,13 @@ public abstract class EntityLivingBase extends Entity {
     }
 
     public void readEntityFromNBT(NBTTagCompound compound) {
-        this.setAbsorptionAmount(compound.getFloat("AbsorptionAmount"));
+        // Paper start - jvm keeps optimizing the setter
+        float absorptionAmount = compound.getFloat("AbsorptionAmount");
+        if (Float.isNaN(absorptionAmount)) {
+            absorptionAmount = 0;
+        }
+        this.setAbsorptionAmount(absorptionAmount);
+        // Paper end
 
         if (compound.hasKey("Attributes", 9) && this.world != null && !this.world.isRemote) {
             SharedMonsterAttributes.setAttributeModifiers(this.getAttributeMap(), compound.getTagList("Attributes", 10));
@@ -847,6 +853,14 @@ public abstract class EntityLivingBase extends Entity {
     }
 
     public void setHealth(float health) {
+        // Paper start
+        if (Float.isNaN(health)) {
+            health = getMaxHealth();
+            if (this.valid) {
+                System.err.println("[NAN-HEALTH] " + getName() + " had NaN health set");
+            }
+        }
+        // Paper end
         if (this instanceof EntityPlayerMP) {
             CraftPlayer player = ((EntityPlayerMP) this).getBukkitEntity();
 
@@ -2329,7 +2343,7 @@ public abstract class EntityLivingBase extends Entity {
     }
 
     public void setAbsorptionAmount(float amount) {
-        if (amount < 0.0F) {
+        if (amount < 0.0F || Float.isNaN(amount)) { // Paper
             amount = 0.0F;
         }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 0dc6fde..fa21f8c 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1459,6 +1459,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     }
 
     public void setRealHealth(double health) {
+        if (Double.isNaN(health)) {return;} // Paper
         this.health = health;
     }
 
-- 
2.18.0

