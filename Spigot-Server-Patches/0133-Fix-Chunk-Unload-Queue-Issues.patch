From 1d3d11787831feedb30ced0b6155f61df35943bf Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 9 Oct 2017 18:16:32 -0400
Subject: [PATCH] Fix Chunk Unload Queue Issues

Vanilla implemented similar logic as Paper had pre 1.9.4, but Spigot
has not resolved all the bugs with the changes.

This patch fixes known issues and really should be applied by Spigot team.

diff --git a/src/main/java/net/minecraft/world/gen/ChunkProviderServer.java b/src/main/java/net/minecraft/world/gen/ChunkProviderServer.java
index 7f3133b..6ce7c1a 100644
--- a/src/main/java/net/minecraft/world/gen/ChunkProviderServer.java
+++ b/src/main/java/net/minecraft/world/gen/ChunkProviderServer.java
@@ -279,13 +279,18 @@ public class ChunkProviderServer implements IChunkProvider {
                     iterator.remove();
                     Chunk chunk = (Chunk) this.id2ChunkMap.get(olong);
 
-                    if (chunk != null
-                            && chunk.unloadQueued
-                            && this.unloadChunk(chunk, true)
-                            && this.droppedChunksSet.size() <= targetSize
-                            && activityAccountant.activityTimeIsExhausted()) {
-                        break;
+                    // Paper start - Split up
+                    if (chunk != null && chunk.unloadQueued) {
+                        chunk.unloadQueued = false; // Paper
+                        if (this.unloadChunk(chunk, true)) {
+                            continue;
+                        }
+
+                        if (this.droppedChunksSet.size() <= targetSize  && activityAccountant.activityTimeIsExhausted()) {
+                            break;
+                        }
                     }
+                    // Paper end
                 }
 
                 activityAccountant.endActivity();
-- 
2.18.0

