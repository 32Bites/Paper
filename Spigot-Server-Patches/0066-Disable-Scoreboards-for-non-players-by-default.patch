From 193699f8980360ca2965caac1c662ae527616652 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sat, 30 Sep 2017 21:36:53 -0400
Subject: [PATCH] Disable Scoreboards for non players by default

Entities collision is checking for scoreboards setting.
This is very heavy to do map lookups for every collision to check
this setting.

So avoid looking up scoreboards and short circuit to the "not on a team"
logic which is most likely to be true.

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index 278f2d6..da39dc2 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -238,4 +238,9 @@ public class PaperWorldConfig {
     private void disableTeleportationSuffocationCheck() {
         disableTeleportationSuffocationCheck = getBoolean("disable-teleportation-suffocation-check", false);
     }
+
+    public boolean nonPlayerEntitiesOnScoreboards = false;
+    private void nonPlayerEntitiesOnScoreboards() {
+        nonPlayerEntitiesOnScoreboards = getBoolean("allow-non-player-entities-on-scoreboards", false);
+    }
 }
diff --git a/src/main/java/net/minecraft/command/server/CommandScoreboard.java b/src/main/java/net/minecraft/command/server/CommandScoreboard.java
index 576ef0e..4596a65 100644
--- a/src/main/java/net/minecraft/command/server/CommandScoreboard.java
+++ b/src/main/java/net/minecraft/command/server/CommandScoreboard.java
@@ -530,6 +530,7 @@ public class CommandScoreboard extends CommandBase {
 
                 if (EntitySelector.isSelector(var9)) {
                     for (Entity var12 : getEntityList(server, sender, var9)) {
+                        if (!var12.world.paperConfig.nonPlayerEntitiesOnScoreboards && !(var12 instanceof EntityPlayer)) { continue; } // Paper
                         String var13 = getEntityName(server, sender, var12.getCachedUniqueIdString());
 
                         if (var5.addPlayerToTeam(var13, var6)) {
diff --git a/src/main/java/net/minecraft/entity/Entity.java b/src/main/java/net/minecraft/entity/Entity.java
index 37cd0bd..6f66400 100644
--- a/src/main/java/net/minecraft/entity/Entity.java
+++ b/src/main/java/net/minecraft/entity/Entity.java
@@ -2095,6 +2095,7 @@ public abstract class Entity implements ICommandSender {
 
     @Nullable
     public Team getTeam() {
+        if (!this.world.paperConfig.nonPlayerEntitiesOnScoreboards && !(this instanceof EntityPlayer)) { return null; } // Paper
         return this.world.getScoreboard().getPlayersTeam(this.getCachedUniqueIdString());
     }
 
-- 
2.18.0

