From 6f0bb252d209fba1554f81cc12b19b734d2bee98 Mon Sep 17 00:00:00 2001
From: mezz <tehgeek@gmail.com>
Date: Sun, 29 Oct 2017 21:36:28 -0400
Subject: [PATCH] Fix MC-117075: TE Unload Lag Spike


diff --git a/src/main/java/net/minecraft/world/World.java b/src/main/java/net/minecraft/world/World.java
index c043f48..8a8efdf 100644
--- a/src/main/java/net/minecraft/world/World.java
+++ b/src/main/java/net/minecraft/world/World.java
@@ -1601,7 +1601,11 @@ public abstract class World implements IBlockAccess {
         this.timings.tileEntityTick.startTiming();
 
         if (!this.tileEntitiesToBeRemoved.isEmpty()) {
-            this.tickableTileEntities.removeAll(this.tileEntitiesToBeRemoved);
+            // Paper start - Use alternate implementation with faster contains
+            java.util.Set<TileEntity> toRemove = java.util.Collections.newSetFromMap(new java.util.IdentityHashMap<>());
+            toRemove.addAll(tileEntitiesToBeRemoved);
+            this.tickableTileEntities.removeAll(toRemove);
+            // Paper end
             //this.loadedTileEntityList.removeAll(this.tileEntitiesToBeRemoved); // Paper - Remove unused list
             this.tileEntitiesToBeRemoved.clear();
         }
-- 
2.18.0

